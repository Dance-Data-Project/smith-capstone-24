---
title: "Endowment Management"
date: "Last updated on `r Sys.Date()`"
author: "Ruiz-Fuentes, Michel"
format: html
editor: visual
theme: cosmo
number-sections: true
---

This section demonstrates calculations and exploratory data visualizations on the balances and help us inquire about how endowment management affects these numbers. By investigating Section D, Part V of the 990 forms on Endowment funds. and variables 1a-g we can learn about the **financial health** and **performance** of the endowment fund including some of its sources of revenue, expense and impacts of the investment activities.

This will also produce insights on the endowment fund's **long-term sustainability** and **perpetuity** which is especially meaningful for smaller endowment's because they can learn from the successes of a larger endowment. It may also help them reevaluate their endowment management and how governance alters in the face economic downturns and market volatility.

How to interpret yearly endowment balance changes and what does it tell us about financial health?

-   A healthy endowment may have consecutive positive differences.

-   Having a larger end of year balance than their beginning of year balance prompts further investigations about whether these trends are attributed to larger sources of revenue such as contributions or investment earnings. Secondly, it would mean these revenue streams are larger than their expenses such as grants/scholarships, administrative expenses and other expenditures.

-   Measuring the endowment balances patterns over multiple fiscal years can inform long-term planning and decision-making. For example, the largest 10 endowment patterns can serve as an example for the smallest 10 endowments to make adjustments to their revenue and expense streams. For instance, this can appear as strategizing to increase investment earnings or contributions for the endowment's continued growth and perpetuity.

This section will demonstrate calculations and exploratory data visualizations on the endowment management and governance using Form 990, Section D, Part V. By investigating variables 1a-g we can learn about the **financial health** and **performance** of the endowment fund including some of its sources of revenue, expense and impacts of the investment activities. This will also produce insights on the endowment fund's **long-term sustainability** and **perpetuity** which is especially meaningful for smaller endowment's because they can learn from the successes of a larger endowment. It may also help them reevaluate their endowment management and how governance alters in the face economic downturns and market volatility.


```{r, include=FALSE}
## Set default behavior for all code chunks here:
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE, 
  fig.width = 16/2, 
  fig.height = 9/2)
```



```{r, loading packages, include=FALSE}
## Load packages
library(dplyr) # data manipulation
library(readr) # scrapes web pages
library(ggplot2) # data visualization
library(janitor) # data manipulation
library(plotly) # interactive visualizations
library(DT) # interactive table
library(stringr) # abbreviate val

set.seed(76)
```

```{r, include=FALSE}
# ## Set directory
setwd("/Users/michelruiz-fuentes/Desktop/smith-capstone-24/990s_assetallocation")

## Load data
schedule_d <- read.csv("schedule_d_vals.csv")
companies <- read.csv("companies.csv")
```

```{r, data wrangling, include=FALSE}
# Cleaning column names
schedule_d <- schedule_d %>%
  clean_names()

schedule_d_cleaned <- 
  schedule_d %>% 
  rename(
    administrative_expenses = x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_administrative_expenses_amt, 
    boy_balance = 
x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_beginning_year_balance_amt,
    contributions = 
x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_contributions_amt,
    eoy_balance=
x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_end_year_balance_amt,
    grants_or_scholarships =
x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_grants_or_scholarships_amt,
    investment_earnings_or_losses = x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_investment_earnings_or_losses_amt,
    other_expenditure = 
x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_other_expenditures_amt,
    total_expenses =
x_return_return_data_irs990schedule_d_total_expenses_per_form990amt)

## schedule_d_cleaned - change data type
schedule_d_cleaned <- schedule_d_cleaned %>%
  mutate(fiscal_year = as.character(fiscal_year)) 
schedule_d_cleaned <- schedule_d_cleaned %>%
  mutate(ein = as.character(ein)) 

# ## Changing EIN to character - companies
# x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_other_expenditures_amt)

# Changing EIN to character - schedule_d
schedule_d_cleaned <- schedule_d_cleaned %>%
  mutate(fiscal_year = as.character(fiscal_year)) 

# Changing EIN to character - schedule_d
schedule_d_cleaned <- schedule_d_cleaned %>%
  mutate(ein = as.character(ein)) 

# Changing EIN to character - companies
companies <- companies %>%
  mutate(ein = as.character(ein)) %>%
  select(ein, organization_name)


# new df with focusedcolumns
schedule_d_cleaned <- schedule_d_cleaned %>% 
  select("ein", 
      "fiscal_year",
      "administrative_expenses", 
      "boy_balance", 
      "contributions", 
      "eoy_balance", 
      "grants_or_scholarships", 
      "investment_earnings_or_losses", 
      "other_expenditure",
      "total_expenses")

## Joining datasets 
schedule_d_cleaned <- schedule_d_cleaned %>%
  left_join(companies , by = 'ein', relationship = "many-to-many")
```

```{r, validity check, include=FALSE}
## ensuring NAs are consistent

## schedule_d_checkvars - change data type
# schedule_d_checkvars <- schedule_d %>%
#   mutate(ein = as.character(ein))

## Validity check
# schedule_d_checkvars <- schedule_d_checkvars %>%
#   select(ein,
#          fiscal_year,
#          x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_beginning_year_balance_amt,
#          x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_end_year_balance_amt, 
#          x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_contributions_amt) %>%
#   left_join(companies , by = 'ein', relationship = "many-to-many") 
# 
# schedule_d_checkvars <- schedule_d_checkvars %>%
#   select(ein,organization_name,fiscal_year,
#          x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_beginning_year_balance_amt,
#          x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_end_year_balance_amt, 
#          x_return_return_data_irs990schedule_d_cy_endwmt_fund_grp_contributions_amt)
```

`Metrics:`

-   EDA of changes in the endowment balances

-   EDA of contributions

-   EDA of investment earnings or losses

```{r, include=FALSE}
## calculating the change in endowment balance, difference between eoy - boy
schedule_d_cleaned <- schedule_d_cleaned %>%
  mutate(difference = (eoy_balance - boy_balance))

## new df with diffs and vars of interest
# df_diffs <- schedule_d_cleaned %>%
#   select(organization_name, fiscal_year, boy_balance, eoy_balance, difference)

# ## total_expenses; sum of administrative_expenses, grants_or_scholarships, other_expenditure
# schedule_d_cleaned <- schedule_d_cleaned %>%
#   mutate(total_expenses = rowSums(
#     select(., administrative_expenses, grants_or_scholarships, other_expenditure)))
#
# ## calculating expense ratio, total expenses relative to the endowment's total assets
# schedule_d_cleaned <- schedule_d_cleaned %>%
#   mutate(expense_ratio = (total_expenses / eoy_balance) * 100)

## new df with expense ratios and vars of interests
# expense_ratio_df <- schedule_d_cleaned %>%
#   select(organization_name, fiscal_year, expense_ratio, eoy_balance, total_expenses)

# net flows reflects net inflow/outflow of contributions to the fund
# schedule_d_cleaned <- schedule_d_cleaned %>%
#   mutate(net_flows = (contributions-grants_or_scholarships))

## set df order for vars
schedule_d_cleaned <- schedule_d_cleaned %>% 
  select(ein, organization_name, fiscal_year, boy_balance, eoy_balance, 
         difference, contributions, investment_earnings_or_losses, 
         grants_or_scholarships, other_expenditure, administrative_expenses, total_expenses)
```

## Endowment Balances from FY16-22

**Table X** prints a complete data frame for stakeholders to observe the beginning or year balances (`boy`), end of year balances (`eoy`), and change over fiscal years 2016-2022, (`differences`) for 173 companies. The differences were calculated by `eoy - boy`. There are a number of interactive features you can utilize to maximize your data exploration such as,

-   By clicking the upward arrow for `differences` you can view the smallest balance changes, and conversely the downward arrow demonstrates the largest balance changes.
-   Within the search bar for `differences` you can manipulate the spectrum of values and customize whether you want to view negative or positive differences.

**How to interpret yearly endowment balance changes and what does it tell us about financial health?**

-   A healthy endowment may have consecutive positive differences. Having a larger end of year balance than their beginning of year balance prompts further investigations about whether these trends are attributed to larger sources of revenue such as contributions or investment earnings. Secondly, it would mean these revenue streams are larger than their expenses such as grants/scholarships, administrative expenses and other expenditures.

-   Measuring the endowment balances patterns over multiple fiscal years can inform long-term planning and decision-making. For example, the largest 10 endowment patterns can serve as an example for the smallest 10 endowments to make adjustments to their revenue and expense streams. For instance, this can appear as strategizing to increase investment earnings or contributions for the endowment's continued growth and perpetuity.

### Dance Company's Endowment Balances and Differences

```{r, interactive table, include=FALSE}
# Sort organization_name alphabetically
df_diffs <- schedule_d_cleaned %>%
  select(organization_name, fiscal_year, boy_balance, eoy_balance, difference) %>%
  arrange(organization_name, fiscal_year)

diffs_table <- datatable(df_diffs, 
                         filter = "top", # where to toggle
                         options = list(pageLength = 10, # organization names per page
                                      lengthMenu = c(10, 25, 50))) # number of rows per page
```

```{r, echo = FALSE}
diffs_table
```

```{r, include=FALSE}
## calculating smallest and largest by expenses in FY2018-2022
scheduleD_groups <- schedule_d_cleaned %>%
  select(ein, organization_name, fiscal_year, total_expenses, difference) %>%
  filter(fiscal_year %in% c("2018", "2019", "2020", "2021", "2022")) 

# calculate the average of total_expenses and compare rankings 
expense_summary_table <- scheduleD_groups %>%
  group_by(organization_name) %>%
  summarize(
    group_n = n(), 
    average = mean(total_expenses),
    median = median(total_expenses),
    max = max(total_expenses),
    min = min(total_expenses))
```

### Largest 5, Endowment Balance Change Over Time

```{r, include=FALSE}
## largest endowments
largest_5 <- schedule_d_cleaned %>% 
  filter(organization_name %in% c("New York City Ballet", 
                                  "Alvin Ailey American Dance Theater", 
                                  "Boston Ballet", 
                                  "Houston Ballet", 
                                  "Joffrey Ballet")) 

largest_10 <- schedule_d_cleaned %>% 
  filter(organization_name %in% c("New York City Ballet", # avg expense, 78250983.6
                                  "Alvin Ailey American Dance Theater", # avg expense, 40508814.4
                                  "Boston Ballet", # avg expense, 31447678.0
                                  "Houston Ballet", # avg expense, 30798842.6
                                  "Joffrey Ballet", # avg expense, 19179594.2
                                  "Miami City Ballet", # avg expense, 18595308.4
                                  "Pennsylvania Ballet", # avg expense, 13947001.0
                                  "Ballet West", # avg expense, 12663388.2
                                  "The Washington Ballet", # avg expense, 12203710.0
                                  "Atlanta Ballet")) # avg expense, 11479259.0
```

**Figure X** depicts a line graph, emphasizing a visual representation of how the endowment balances fluctuate over time for each company. It highlights periods of growth, decline, or stability in each company's financial position across fiscal years.

**Key Findings:** In 2021, four of the five largest endowments experiences a sharp increase in their endowment balance differences where EOY is larger than BOY. These include New York City Ballet, Houston Ballet, Alvin Ailey American Dance Theater, and Boston Ballet. Similarly, in previous years, 2017, three of these companies also experienced a sharp increase in their differences. As of our latest fiscal year 2022, Boston Ballet is the only company to have a positive difference, prompting questions about whether their endowment management and revenue vs expense proportions varied from the other four endowments.

```{r, interactive largest 5, include=FALSE}
# Create ggplot visualization
largest_5_changeovertime <- 
  ggplot(data = largest_5, 
         aes(x = fiscal_year, y = difference, 
         group = organization_name, color = organization_name)) +
         geom_line(aes(color = organization_name)) +
         labs(title = "Largest 5 Companies",
               subtitle = "Comparing Balance Changes FY16-2022",
               x = "Fiscal Year",
               y = "Balance Differences ($)", 
               caption = "Source: Schedule D, Part V") +
         scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 

# Convert ggplot to Plotly object
viz_L5_plotly <- ggplotly(largest_5_changeovertime) #viz_top5_change_plotly <-

# Create a Plotly plot with traces for each organization
L5_changes <- plot_ly() %>%
          add_trace(data = largest_5, x = ~fiscal_year, y = ~difference,
                    group = ~organization_name, color = ~organization_name,
                    type = "scatter", mode = "lines",
                    name = ~organization_name) %>%  # Use org var for the trace name
          layout(title = "Largest 5: Comparing Balance Changes FY16-2022",
            xaxis = list(title = "Fiscal Year"),
            yaxis = list(title = "Balances Differences ($)"),
            updatemenus = list(list(
                type = "buttons",
                buttons = list(
                  list(method = "restyle",
                       args = list("visible", list(TRUE)),
                       label = "Show All Companies")))))

# # Add traces from ggplot to Plotly plot
for (i in 1:length(viz_L5_plotly$x$data)) 
  {L5_changes <- 
    L5_changes %>% 
    add_trace(viz_L5_plotly$x$data[[i]])}
```

```{r, echo = FALSE}
L5_changes
```

### Largest 5, Distribution of Differences

In **Figure X**, we observe similar trends to the line graph, but with a focus on the distribution, central tendency and spread of the values against competitors, as opposed to specifically the change over time. The median points of the top five ballet companies are within the same range, and a summary table can particularly distinguish what these values are. This indicates for all companies, half of the data is above and below this line and has a similar spread. Contrastingly, the size of the interquartile ranges and boxes differ starkly. In order from largest to smallest it goes as: New York City Ballet, San Francisco Ballet, Houston Ballet, Alvin Ailey American Dance Theater and Boston Ballet. Additionally by interpreting the shape of the box in relation to the medians, we notice that four companies are skewed while only one company has a proper median that equally splits the quartile into halves.

```{r, largest5 spread, include=FALSE}
largest_5$organization_name <- str_wrap(largest_5$organization_name, width = 12)

L5_spread <- 
  ggplot(data = largest_5, aes(x = organization_name, y = difference, group = organization_name, color = organization_name)) +
  geom_boxplot(aes(color = organization_name)) +
  labs(title = "Largest 5 Companies: Spread of Differences",
       subtitle = "Comparing Balance Changes FY16-2022",
       x = "Company Name",
       y = "Balance Differences ($)", 
       caption = "Source: Schedule D, Part V") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) 

viz_L5_spread_plotly <- ggplotly(L5_spread)
```

```{r, echo = FALSE}
viz_L5_spread_plotly
```

### Largest 10, Endowment Balance Change Over Time

**Figure X**

```{r, interactive largest 10, include=FALSE}
# Create ggplot visualization
largest_10_changeovertime <- 
  ggplot(data = largest_10, 
         aes(x = fiscal_year, y = difference, 
         group = organization_name, color = organization_name)) +
         geom_line(aes(color = organization_name)) +
         labs(title = "Largest 10 Companies",
               subtitle = "Comparing Balance Changes FY16-2022",
               x = "Fiscal Year",
               y = "Balance Differences ($)", 
               caption = "Source: Schedule D, Part V") +
         scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 

# Convert ggplot to Plotly object
viz_L10_plotly <- ggplotly(largest_10_changeovertime) #viz_top5_change_plotly <-

# Create a Plotly plot with traces for each organization
L10_changes <- plot_ly() %>%
          add_trace(data = largest_10, x = ~fiscal_year, y = ~difference,
                    group = ~organization_name, color = ~organization_name,
                    type = "scatter", mode = "lines",
                    name = ~organization_name) %>%  # Use org var for the trace name
          layout(title = "Largest 10: Comparing Balance Changes FY16-2022",
            xaxis = list(title = "Fiscal Year"),
            yaxis = list(title = "Balances Differences ($)"),
            updatemenus = list(list(
                type = "buttons",
                buttons = list(
                  list(method = "restyle",
                       args = list("visible", list(TRUE)),
                       label = "Show All Companies")))))

# # Add traces from ggplot to Plotly plot
for (i in 1:length(viz_L10_plotly$x$data)) 
  {L10_changes <- 
    L10_changes %>% 
    add_trace(viz_L10_plotly$x$data[[i]])}
```

```{r, echo = FALSE}
L10_changes
```

### Largest 10, Distribution of Differences

**Figure X**

```{r, largest10 spread, include=FALSE}
largest_10$organization_name <- str_wrap(largest_10$organization_name, width = 12)

L10_spread <- 
  ggplot(data = largest_10, aes(x = organization_name, y = difference, group = organization_name, color = organization_name)) +
  geom_boxplot(aes(color = organization_name)) +
  labs(title = "Largest 10 Companies: Spread of Differences",
       subtitle = "Comparing Balance Changes FY16-2022",
       x = "Company Name",
       y = "Balance Differences ($)", 
       caption = "Source: Schedule D, Part V") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) 

viz_L10_spread_plotly <- ggplotly(L10_spread)
```

```{r, echo = FALSE}
viz_L10_spread_plotly
```

### Smallest 5, Endowment Balance Change Over Time

```{r, include=FALSE}
# new way to determine smallest 5 and 10 since the currents have NAs in differences
scheduleD_diff_avg <- scheduleD_groups %>%
  group_by(organization_name) %>%
  mutate(average_diff = mean(difference)) %>%
  select(organization_name, total_expenses, average_diff)
```

```{r, include=FALSE}
## smallest endowments BASED ON EXPENSES
smallest_5 <- schedule_d_cleaned %>% 
  filter(organization_name %in% c("Ballet Frontier", 
                                  "Ballet Quad Cities", 
                                  "Moveius Contemporary Ballet", 
                                  "Portland Ballet", 
                                  "Chattanooga Ballet"))
smallest_10 <- schedule_d_cleaned %>% 
  filter(organization_name %in% c("Ballet Frontier", # avg expense, 250069.6
                                  "Ballet Quad Cities", # avg expense, 372069.0
                                  "Moveius Contemporary Ballet", # avg expense, 469734.8
                                  "Portland Ballet", # avg expense, 495371.6
                                  "Chattanooga Ballet", # avg expense, 534258.2
                                  "First State Ballet Theatre", # avg expense, 593174.0
                                  "Oakland Ballet Company", # avg expense, 751864.8
                                  "Huntsville Ballet Company", # avg expense, 781799.3
                                  "Rochester City Ballet", # avg expense, 841542.6
                                  "Ballet Theatre of Maryland")) # avg expense, 844564.8

# calculate the average of diff and compare rankings 
smallest_5_a <- schedule_d_cleaned %>% 
  filter(organization_name %in% c("Ballet Quad Cities", 
                                  "New Mexico Ballet Company", 
                                  "Fort Wayne Ballet", 
                                  "Eugene Ballet", 
                                  "Grand Rapids Ballet"))
smallest_10_a <- schedule_d_cleaned %>% 
  filter(organization_name %in% c("Ballet Quad Cities", 
                                  "New Mexico Ballet Company", 
                                  "Fort Wayne Ballet", 
                                  "Eugene Ballet", 
                                  "Grand Rapids Ballet",
                                  "The Alabama Ballet",
                                  "Nevada Ballet Theatre",
                                  "Ballet Memphis",
                                  "Oregon Ballet Theatre",
                                  "BalletMet")) 
```

**Figure X** presents the dynamic changes in the endowment balances across the bottom 5 ballet companies from our sample. We noticed that of the three companies, the trends of the Tallahassee Ballet and Ballet Quad Cities are closely alike through the fiscal years 2016- 2022, while the trends of the First State Ballet Theater experience a dip and spike from 2018- 2020. Moreover, the Canyon Concert Ballet data also starts in 2021 which can indicate there were no differences until this point, or the endowment started later than the others so it is missing data and has a different timeline from the 2016-2022 approximation. The y-axis range of dollars for the endowment balance differences is also 3x smaller for the smallest companies compared to the largest companies.

```{r, interactive smallest 5, include=FALSE}
# Create ggplot visualization
smallest_5_changeovertime <- 
  ggplot(data = smallest_5_a, 
         aes(x = fiscal_year, y = difference, 
         group = organization_name, color = organization_name)) +
         geom_line(aes(color = organization_name)) +
         labs(title = "Smallest 5 Companies",
               subtitle = "Comparing Balance Changes FY16-2022",
               x = "Fiscal Year",
               y = "Balance Differences ($)", 
               caption = "Source: Schedule D, Part V") +
         scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 

# Convert ggplot to Plotly object
viz_S5_plotly <- ggplotly(smallest_5_changeovertime) #viz_top5_change_plotly <-

# Create a Plotly plot with traces for each organization
S5_changes <- plot_ly() %>%
          add_trace(data = smallest_5_a, x = ~fiscal_year, y = ~difference,
                    group = ~organization_name, color = ~organization_name,
                    type = "scatter", mode = "lines",
                    name = ~organization_name) %>%  # Use org var for the trace name
          layout(title = "Smallest 5: Comparing Balance Changes FY16-2022",
            xaxis = list(title = "Fiscal Year"),
            yaxis = list(title = "Balances Differences ($)"),
            updatemenus = list(list(
                type = "buttons",
                buttons = list(
                  list(method = "restyle",
                       args = list("visible", list(TRUE)),
                       label = "Show All Companies")))))

# # Add traces from ggplot to Plotly plot
for (i in 1:length(viz_S5_plotly$x$data)) 
  {S5_changes <- 
    S5_changes %>% 
    add_trace(viz_S5_plotly$x$data[[i]])}
```

```{r, echo = FALSE}
S5_changes
```

### Smallest 5, Distribution of Differences

**Figure X** highlights periods of growth, decline, or stability in each company's financial position across fiscal years. For example, the sizes of the interquartile ranges of boxes for all four endowments are small in comparison to the larger endowments which indicates their end of year balances did not significantly differ from the start of year balances. Further investigations could reveal if this was attributed to contributions, investment earnings or losses and sources of expenditure such as administrative expenses or grants and scholarships.

```{r, smallest5 spread, include=FALSE}
smallest_5_a$organization_name <- str_wrap(smallest_5_a$organization_name, width = 12)

S5_spread <- 
  ggplot(data = smallest_5_a, aes(x = organization_name, y = difference, group = organization_name, color = organization_name)) +
  geom_boxplot(aes(color = organization_name)) +
  labs(title = "Smallest 5 Companies: Spread of Differences",
       subtitle = "Comparing Balance Changes FY16-2022",
       x = "Company Name",
       y = "Balance Differences ($)", 
       caption = "Source: Schedule D, Part V") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) 

viz_S5_spread_plotly <- ggplotly(S5_spread)
```

```{r, echo=FALSE}
viz_S5_spread_plotly
```

### Smallest 10, Endowment Balance Change Over Time

**Figure X**

```{r, interactive smallest 10, include=FALSE}
# Create ggplot visualization
smallest_10_changeovertime <- 
  ggplot(data = smallest_10_a, 
         aes(x = fiscal_year, y = difference, 
         group = organization_name, color = organization_name)) +
         geom_line(aes(color = organization_name)) +
         labs(title = "Smallest 10 Companies",
               subtitle = "Comparing Balance Changes FY16-2022",
               x = "Fiscal Year",
               y = "Balance Differences ($)", 
               caption = "Source: Schedule D, Part V") +
         scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 

# Convert ggplot to Plotly object
viz_S10_plotly <- ggplotly(smallest_10_changeovertime) #viz_top5_change_plotly <-

# Create a Plotly plot with traces for each organization
S10_changes <- plot_ly() %>%
          add_trace(data = smallest_10_a, x = ~fiscal_year, y = ~difference,
                    group = ~organization_name, color = ~organization_name,
                    type = "scatter", mode = "lines",
                    name = ~organization_name) %>%  # Use org var for the trace name
          layout(title = "Smallest 10: Comparing Balance Changes FY16-2022",
            xaxis = list(title = "Fiscal Year"),
            yaxis = list(title = "Balances Differences ($)"),
            updatemenus = list(list(
                type = "buttons",
                buttons = list(
                  list(method = "restyle",
                       args = list("visible", list(TRUE)),
                       label = "Show All Companies")))))

# # Add traces from ggplot to Plotly plot
for (i in 1:length(viz_S10_plotly$x$data)) 
  {S10_changes <- 
    S10_changes %>% 
    add_trace(viz_S10_plotly$x$data[[i]])}
```

```{r, echo = FALSE}
S10_changes
```

### Smallest 10, Distribution of Differences

**Figure X**

```{r, smallest10 spread, include=FALSE}
smallest_10_a$organization_name <- str_wrap(smallest_10_a$organization_name, width = 12)

S10_spread <- 
  ggplot(data = smallest_10_a, aes(x = organization_name, y = difference, group = organization_name, color = organization_name)) +
  geom_boxplot(aes(color = organization_name)) +
  labs(title = "Smallest 10 Companies: Spread of Differences",
       subtitle = "Comparing Balance Changes FY16-2022",
       x = "Company Name",
       y = "Balance Differences ($)", 
       caption = "Source: Schedule D, Part V") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  theme(axis.text.x = element_text(angle = 75, hjust = 1)) 

viz_S10_spread_plotly <- ggplotly(S10_spread)
```

```{r, echo=FALSE}
viz_S10_spread_plotly
```

## EDA of Contributions

**EDA of contributions and over the fiscal years**

```{r, include=FALSE}
# contributions <- 
#   ggplot(data = schedule_d_cleaned, aes(x = organization_name , y = fiscal_year)) +
#   geom_boxplot() +
#   labs(title = "Bottom 5 Ballet Funds: Endowment Balance Changes",
#        subtitle = "Fiscal Years 2016-2022",
#        x = "Difference ($)",
#        y = "Company", 
#        caption="Source: Schedule D, Part V") +
#   scale_x_continuous(labels = function(x) format(x, scientific = FALSE))
```

## EDA of Investment Earnings or Losses

**Adding bar chart for investment_earnings_or_loss**

## \[N/A\] Expense Ratio

How does it evaluate the fund's [financial health]{.underline}: a healthy endowment may have a decreasing expense ratio because the firm may become more efficient at allocating expenses while an increase may indicate a financial strain or higher expenses on the firm.

How does it evaluate the fund's [sustainability:]{.underline} a consistent expense ratio may reveal a pattern into the endowment's operations and spending habits; maintaining a 'sustainable' ratio is crucial to maintaining the endowment's perpetuity and preserving their abilities to meet their objectives

```{r, include=FALSE}
# ## example snapshot of expense ratios for SF
# nyc_er <- expense_ratio_df %>%
#   filter(organization_name == "New York City Ballet")
# sf_er <- expense_ratio_df %>%
#   filter(organization_name == "San Francisco Ballet")
```

```{r, include=FALSE}
# ## print the first few rows of New York City Ballet 
# print(head(nyc_er))
```

```{r, include=FALSE}
# ## print the first few rows of San Francisco Ballet
# print(head(sf_er))
```

```{r, include=FALSE}
# ## Converting data from wide to long and selecting Part V columns from 990s
# expense_ratio_df_2017 <- subset(expense_ratio_df, fiscal_year == "2017")
# expense_ratio_df_2018 <- subset(expense_ratio_df, fiscal_year == "2018")
# expense_ratio_df_2019 <- subset(expense_ratio_df, fiscal_year == "2019")
# expense_ratio_df_2020 <- subset(expense_ratio_df, fiscal_year == "2020")
# expense_ratio_df_2021 <- subset(expense_ratio_df, fiscal_year == "2021")
# expense_ratio_df_2022 <- subset(expense_ratio_df, fiscal_year == "2022")
```

```{r, Visualizations, top5 rates, include=FALSE}
# viz_top5_er <- 
#   ggplot(data = top5, aes(x = fiscal_year, y = expense_ratio, 
#                              col = organization_name)) + 
#   geom_point() + 
#   # geom_smooth(method = "loess", se = FALSE) + 
#   labs(title = "Top 5 Ballet Funds: Expense Ratios Over Time",
#        subtitle = "Fiscal Years 2016-2022",
#        x = "Fiscal Year",
#        y = "Expense Ratio", 
#        caption = "Source: Schedule D, Part V") +
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE))
```

```{r, include=FALSE}
# viz_top5_er
```

```{r, include=FALSE}
# viz_top_er_spread <- 
#   ggplot(data = top5, aes(x = expense_ratio , y = fiscal_year, 
#     group = organization_name, color = organization_name)) +
#   geom_boxplot() +
#   labs(title = "Top 5 Ballet Funds: Spread of Expense Ratios",
#        subtitle = "Fiscal Years 2016-2022",
#        x = "Expense Ratio",
#        y = "Company", 
#        caption="Source: Schedule D, Part V") +
#   scale_x_continuous(labels = function(x) format(x, scientific = FALSE))
```

```{r, include=FALSE}
#  viz_top_er_spread
```

```{r, include=FALSE}
# expense_ratio_spread17 <- 
#   ggplot (expense_ratio_df_2017, aes(x= organization_name, y= expense_ratio)) +
#   geom_boxplot () + 
#   facet_wrap(~eoy_balance, scales = "free") + 
#   labs(title = "Distribution of Expense Ratios",
#     subtitle = "Schedule D, Part V, 2017 Filings",
#     x = "Expense Ratio (%)",
#     y = "Frequency") 
```

## About the Data \[[source](https://www.irs.gov/pub/irs-pdf/i990sd.pdf)\]

`Schedule_d_cleaned` contains 1061 observations and 10 variables. Three of the variables are characters: the organization name, fiscal year and EIN code; while seven of the variables are integers demonstrating different quantitative aspects of the endowment fund.

For example,

-   `organization_name` : Company names provided by DDP

-   `ein` : unique nine-digit number assigned by the IRS to identity a business entity, 501(c) non-profits

-   `fiscal_year` : a 12-month period that a non-profit organization uses for financial reporting and budgeting purposes

-   `boy_balance` **\[1a\]**: beginning-of-year balances on the organization's endowment funds for the current year; includes cumulative total of funds and assets held in the endowment from previous periods

-   `contributions` **\[1b\]**: enter the amounts of contributions; includes donor gifts, grants, monetary donations and contributions in the form of assets or securities, as well as additional funds established by the organization's governing board to function like an endowment

-   `investment_earnings_or_losses` **\[1c\]**: represents income or losses generates from investing the endowments funds in financial markets (such as interest, dividends, capital gains or losses on investments), including both realized and unrealized amounts; for example reported net of transaction costs and earnings reported on a gross basis

-   `grants_or_scholarships` **\[1d\]**: enter the amounts distributed for grants and scholarships; scholarships represent direct aid to individuals, they are distinguished from general programmatic aid referenced; funds disbursed to support specific programs, projects or individuals

-   `other_expenditure` **\[1e\]**: encompasses any additional expenses incurred by the endowment fund during the fiscal year that are not classified as administrative expenses or grants/scholarships; may include fees for investment management, legal expenses, or other operational costs

-   `administrative_expenses` **\[1f\]**: expenses can arise from either internal or third-party sources; relate to general operation and management such as salaries of administrative staff, office rent, utilities, and other overhead expenses

-   `eoy_balance` **\[1g\]**: determined by adding investing earnings and subtracting investment losses to the beginning of year balance, after grants or scholarships have been awarded and other expenditures

```{r, include=FALSE}
# ## example snapshot of changes in fiscal year balances
# balance_diff_sf <- schedule_d_cleaned %>%
#   filter(organization_name == "San Francisco Ballet")
# ## print the first few rows of San Francisco Ballet
# print(head(balance_diff_sf))
# 
# # Figure 13 illustrates the variations in balance between the end and beginning of the year for San Francisco, another significantly large ballet company. These balances show varying differences and interestingly the balance remains the same in 2016. In future analyses, we can observe a larger range of data to see what the balances were before 2016. Across the fiscal years spanning from 2016 to 2022, the average variance amounts to $62,06,321.
```

```{r, include=FALSE}
# ## example snapshot of changes in fiscal year balances
# balance_diff_nyc <- schedule_d_cleaned %>%
#   filter(organization_name == "New York City Ballet") %>%
#   select(organization_name, fiscal_year, difference)
# 
# ## print the first few rows of New York City Ballet
# print(head(balance_diff_nyc))
# 
# # # Figure 12 demonstrates the changes between the end of year and start of year balance for the New York City ballet, one of the largest ballet dance companies. We witness an inconsistent fluctuation of these balances. The trends range from a positive difference, indicating a larger end of year balance compared to the start of year balance, and then negative balances demonstrating vice versa. Overall, the fiscal years from 2016 to 2022 have a mean difference of $13,678,566.
#       "other_expenditure")

# # Joining datasets 
# schedule_d_cleaned <- schedule_d_cleaned %>%
#   left_join(companies , by = 'ein', relationship = "many-to-many")
# 
# # Function to filter out year
# pick_vars <- function(data, fiscal_year) {
#   select("ein", 
#       "administrative_expenses", 
#       "boy_balance", 
#       "contributions", 
#       "eoy_balance", 
#       "grants_or_scholarships", 
#       "investment_earnings_or_losses", 
#       "other_expenditure")}
# 
# # Converting data from wide to long and selecting Part V columns from 990s
# schedule_d_2017 <- subset(schedule_d_cleaned, fiscal_year == "2017")
# schedule_d_2018 <- subset(schedule_d_cleaned, fiscal_year == "2018")
# schedule_d_2019 <- subset(schedule_d_cleaned, fiscal_year == "2019")
# schedule_d_2020 <- subset(schedule_d_cleaned, fiscal_year == "2020")
# schedule_d_2021 <- subset(schedule_d_cleaned, fiscal_year == "2021")
# schedule_d_2022 <- subset(schedule_d_cleaned, fiscal_year == "2022")
```
