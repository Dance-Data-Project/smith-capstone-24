pct_change_med <- pct_change_ds %>%
group_by(fiscal_year) %>%
summarize(median = median(pct_change, na.rm = TRUE)) %>%
mutate(organization_name = "Median",
fiscal_year_dt = paste(fiscal_year, "-01-01", sep = ""))
pct_change_med$fiscal_year_dt = as.Date(pct_change_med$fiscal_year_dt, format = "%Y-%m-%d")
## Spend Down over Time
pct_change_plot <- pct_change_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(alpha = 0.5, show.legend =FALSE) +
theme_bw() +
scale_colour_manual(values = pal) +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20)) +
geom_hline(yintercept = 100, linetype = "dotted", color = "gray") +
geom_point(data = pct_change_med, aes(x = fiscal_year, y = median), color = "black", size = 1)
pct_change_plot
#ggplotly(pct_change_plot)
##Plot with Y scale between -100 and 100
limited_scale <- pct_change_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(show.legend = FALSE, alpha = 0.5) +
theme_bw() +
scale_colour_manual(values = pal) +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance (max 100)",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20),
limits = c(-100, 100))  +
geom_point(data = pct_change_med, aes(x = fiscal_year, y = median), color = "black", size = 1)
limited_scale
#ggplotly(limited_scale)
## Retrieving median values
pct_change_inv_med <- pct_change_inv_ds %>%
group_by(fiscal_year) %>%
summarize(median = median(pct_change, na.rm = TRUE)) %>%
mutate(organization_name = "Median")
## Spend Down over Time
pct_change_inv_plot <- pct_change_inv_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(alpha = 0.5, show.legend = FALSE) +
scale_colour_manual(values = pal) +
theme_bw() +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20)) +
geom_hline(yintercept = 100, linetype = "dotted", color = "gray")  +
geom_point(data = pct_change_inv_med, aes(x = fiscal_year, y = median), color = "black", size = 1)
pct_change_inv_plot
#ggplotly(pct_change_inv_plot)
##Plot with Y scale between -100 and 100
limited_scale_inv <- pct_change_inv_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(show.legend = FALSE, alpha = 0.5) +
scale_colour_manual(values = pal) +
theme_bw() +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance (max 100)",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20),
limits = c(-100, 100))  +
geom_point(data = pct_change_inv_med, aes(x = fiscal_year, y = median), color = "black", size = 0.5)
limited_scale_inv
#ggplotly(limited_scale_inv)
## Adding end date
source(here("GET_VARS.R"))
##Specifically reading in Tax Period End Date
files <- dir( here("ballet_990_released_20230208"),
full.names = TRUE)
taxperiod_data <- map_df(files, ~
get_df(variables =  c("//Return//ReturnHeader//TaxPeriodEndDt"),
filename = .x
))
taxperiod_data$fiscal_year = as.numeric(as.character(taxperiod_data$fiscal_year))
pct_change_ds <- pct_change_ds %>%
left_join(taxperiod_data, by = c("EIN", "fiscal_year"))
#### USE THIS
## (EYB - BYB)/BYB * 100
## Rose has notes on her choice for this calculation
endowment_data$BeginningYearBalanceAmt <- as.numeric(as.character(endowment_data$BeginningYearBalanceAmt))
endowment_data$ContributionsAmt <- as.numeric(as.character(endowment_data$ContributionsAmt))
endowment_data$OtherExpendituresAmt <- as.numeric(as.character(endowment_data$OtherExpendituresAmt))
endowment_data$AdministrativeExpensesAmt <- as.numeric(as.character(endowment_data$AdministrativeExpensesAmt))
endowment_data$GrantsOrScholarshipsAmt <- as.numeric(as.character(endowment_data$GrantsOrScholarshipsAmt))
endowment_data$InvestmentEarningsOrLossesAmt <- as.numeric(as.character(endowment_data$InvestmentEarningsOrLossesAmt))
endowment_data$EndYearBalanceAmt <- as.numeric(as.character(endowment_data$EndYearBalanceAmt))
pct_change_ds <- endowment_data %>%
filter(!is.na(BeginningYearBalanceAmt)) %>%
mutate(change = EndYearBalanceAmt - BeginningYearBalanceAmt,
pct_change = change/BeginningYearBalanceAmt * 100) %>%
arrange(desc(pct_change)) %>%
left_join(names, by = "ein")
View(endowment_data)
pct_change_ds <- endowment_data %>%
filter(!is.na(BeginningYearBalanceAmt)) %>%
mutate(change = EndYearBalanceAmt - BeginningYearBalanceAmt,
pct_change = change/BeginningYearBalanceAmt * 100) %>%
arrange(desc(pct_change))
View(pct_change_ds)
#### USE THIS
## (EYB - BYB)/BYB * 100
## Rose has notes on her choice for this calculation
endowment_data$BeginningYearBalanceAmt <- as.numeric(as.character(endowment_data$BeginningYearBalanceAmt))
endowment_data$ContributionsAmt <- as.numeric(as.character(endowment_data$ContributionsAmt))
endowment_data$OtherExpendituresAmt <- as.numeric(as.character(endowment_data$OtherExpendituresAmt))
endowment_data$AdministrativeExpensesAmt <- as.numeric(as.character(endowment_data$AdministrativeExpensesAmt))
endowment_data$GrantsOrScholarshipsAmt <- as.numeric(as.character(endowment_data$GrantsOrScholarshipsAmt))
endowment_data$InvestmentEarningsOrLossesAmt <- as.numeric(as.character(endowment_data$InvestmentEarningsOrLossesAmt))
endowment_data$EndYearBalanceAmt <- as.numeric(as.character(endowment_data$EndYearBalanceAmt))
pct_change_ds <- endowment_data %>%
filter(!is.na(BeginningYearBalanceAmt)) %>%
mutate(change = EndYearBalanceAmt - BeginningYearBalanceAmt,
pct_change = change/BeginningYearBalanceAmt * 100) %>%
arrange(desc(pct_change)) %>%
left_join(names, by = "EIN")
library(tidyverse)
library(here)
library(kableExtra)
#library(plotly)
library(viridis)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
# make kable table with consistent formatting
make_table <- function(..., title = "", col_names = c("")) {
df <- as.data.frame(...)
title <- paste0("<center><span style = 'font-size:150%;color:black'><b>",
title,
"</span></b><center>")
as_tibble(df) %>%
kbl(caption = title,
col.names = col_names) %>%
kable_material() %>%
row_spec(row=0, background = "#43494C" , color = "white", bold = TRUE)
}
#######################################
# CREATE BIG PALETTE WITH MANY COLORS
#######################################
pal1 <- viridis_pal(option="mako", end = .9)(12)
pal2 <- viridis_pal(option="rocket", end = .8)(12)
pal3 <- viridis_pal(option="magma", end = .9)(12)
pal4 <- viridis_pal(option="inferno", end = .8)(12)
set.seed(123)
pal <- c(pal1, pal2, pal3, pal4)
indexes <- sample.int(length(pal), replace=FALSE)
pal <- pal[indexes]
## Loading in data
endowment_data <- read_rds(here("data", "endowments_by_most_recent_filings.RDS"))
names <- readRDS(here("data","companies.RDS"))
names <- names %>%
rename(organization_name = Company)
names <- names %>%
mutate(organization_name = ifelse(
organization_name == "Ballet Hispanico",
"Ballet Hisp√°nico",
organization_name))
#### USE THIS
## (EYB - BYB)/BYB * 100
## Rose has notes on her choice for this calculation
endowment_data$BeginningYearBalanceAmt <- as.numeric(as.character(endowment_data$BeginningYearBalanceAmt))
endowment_data$ContributionsAmt <- as.numeric(as.character(endowment_data$ContributionsAmt))
endowment_data$OtherExpendituresAmt <- as.numeric(as.character(endowment_data$OtherExpendituresAmt))
endowment_data$AdministrativeExpensesAmt <- as.numeric(as.character(endowment_data$AdministrativeExpensesAmt))
endowment_data$GrantsOrScholarshipsAmt <- as.numeric(as.character(endowment_data$GrantsOrScholarshipsAmt))
endowment_data$InvestmentEarningsOrLossesAmt <- as.numeric(as.character(endowment_data$InvestmentEarningsOrLossesAmt))
endowment_data$EndYearBalanceAmt <- as.numeric(as.character(endowment_data$EndYearBalanceAmt))
pct_change_ds <- endowment_data %>%
filter(!is.na(BeginningYearBalanceAmt)) %>%
mutate(change = EndYearBalanceAmt - BeginningYearBalanceAmt,
pct_change = change/BeginningYearBalanceAmt * 100) %>%
arrange(desc(pct_change)) %>%
left_join(names, by = "EIN")
#### USE THIS
## (EYB - INV - BYB)/BYB * 100
## Rose has notes on her choice for this calculation
pct_change_inv_ds <- endowment_data %>%
filter(!is.na(BeginningYearBalanceAmt)) %>%
mutate(InvestmentEarningsOrLossesAmt = ifelse(is.na(InvestmentEarningsOrLossesAmt), 0, InvestmentEarningsOrLossesAmt)) %>%
mutate(change = EndYearBalanceAmt - InvestmentEarningsOrLossesAmt - BeginningYearBalanceAmt,
pct_change = change/BeginningYearBalanceAmt * 100) %>%
arrange(desc(pct_change)) %>%
left_join(names, by = "EIN")
# Basic summary stats
pct_change_ds %>%
filter(!is.na(pct_change) & pct_change != Inf) %>%
summarize(avg_pct_change = mean(pct_change),
median_pct_change = median(pct_change),
sd_pct_change = sd(pct_change))
pct_change_ds %>%
filter(!is.na(pct_change) & pct_change != Inf) %>%
group_by(EIN) %>%
summarize(avg_pct_change = mean(pct_change),
median_pct_change = median(pct_change),
sd_pct_change = sd(pct_change))
# Basic histogram summarizing it
ggplot(pct_change_ds, aes(x = pct_change)) +
geom_histogram(binwidth = 20) +
xlab("% Change\n(EYB - BYB) / BYB * 100") +
ggtitle(label = "Percentage of Change in Endowment Balance", subtitle = "Red Line indicates 100%") +
theme_classic() +
geom_vline(xintercept = 100, color = "maroon", linetype = "dotted")
## Histogram with cutoff of 200%
ggplot(pct_change_ds, aes(x = pct_change)) +
geom_histogram(binwidth = 5) +
xlab("% Change\n(EYB - BYB) / BYB * 100") +
xlim(-100, 200) +
ggtitle(label = "Percentage of Change in Endowment Balance") +
theme_classic()
pct_change_ds %>%
filter(pct_change != Inf) %>%
select(organization_name, fiscal_year, pct_change) %>%
make_table(title = "Percentage of Change in Endowment Balance", col_names = c("Name", "Fiscal Year", "% Change")) %>%
scroll_box(height = "450px")
pct_change_ds %>%
filter(pct_change != Inf) %>%
select(organization_name, fiscal_year, pct_change) %>%
group_by(fiscal_year) %>%
summarize(total = n(),
avg = mean(pct_change),
med = median(pct_change),
sd = sd(pct_change)) %>%
make_table(title = "Percentage of Change in Endowment Balance By Year",
col_names = c("Fiscal Year", "Total Companies", "Average % Change",
"Median % Change", "Standard Deviation")) %>%
scroll_box(height = "450px")
# Basic summary stats
pct_change_inv_ds %>%
filter(!is.na(pct_change) & pct_change != Inf) %>%
summarize(avg_pct_change = mean(pct_change),
median_pct_change = median(pct_change),
sd_pct_change = sd(pct_change))
pct_change_inv_ds %>%
filter(!is.na(pct_change) & pct_change != Inf) %>%
group_by(EIN) %>%
summarize(avg_pct_change = mean(pct_change),
median_pct_change = median(pct_change),
sd_pct_change = sd(pct_change))
# Basic histogram summarizing it
ggplot(pct_change_inv_ds, aes(x = pct_change)) +
geom_histogram(binwidth = 20) +
xlab("% Change\n(EYB - INV - BYB) / BYB * 100") +
ggtitle(label = "Percentage of Change in Endowment Balance", subtitle = "Red Line indicates 100%") +
theme_classic() +
geom_vline(xintercept = 100, color = "maroon", linetype = "dotted")
## Histogram with cutoff of 200%
ggplot(pct_change_inv_ds, aes(x = pct_change)) +
geom_histogram(binwidth = 5) +
xlab("% Change\n(EYB - BYB) / BYB * 100") +
xlim(-100, 200) +
ggtitle(label = "Percentage of Change in Endowment Balance") +
theme_classic()
pct_change_inv_ds %>%
filter(pct_change != Inf) %>%
select(organization_name, fiscal_year, pct_change) %>%
make_table(title = "Percentage of Change in Endowment Balance", col_names = c("Name", "Fiscal Year", "% Change")) %>%
scroll_box(height = "450px")
pct_change_inv_ds %>%
filter(pct_change != Inf) %>%
select(organization_name, fiscal_year, pct_change) %>%
group_by(fiscal_year) %>%
summarize(total = n(),
avg = mean(pct_change),
med = median(pct_change),
sd = sd(pct_change)) %>%
make_table(title = "Percentage of Change in Endowment Balance By Year", col_names = c("Fiscal Year", "Total Companies", "Average % Change", "Median % Change", "Standard Deviation")) %>%
scroll_box(height = "450px")
## Ranges of different percent change
# Reordering by standard deviation of pct_spend down
pct_change_ds_box <- pct_change_ds %>%
group_by(organization_name) %>%
filter(pct_change != Inf) %>%
summarize(sd = sd(pct_change, na.rm = TRUE)) %>%
right_join(pct_change_ds, by = "organization_name") %>%
select(organization_name, EIN, pct_change, sd) %>%
mutate(organization_name = reorder(organization_name, -sd, na.rm = TRUE))
## Unlimited
box_plot <- ggplot(pct_change_ds_box, aes(x = organization_name, y = pct_change)) +
geom_boxplot(aes(color = organization_name), show.legend = FALSE) +
geom_point(size = 1, alpha = 0.5, show.legend = FALSE) +
theme_bw() +
labs(title = "Range of Endowment Percent Change per Company",
x = "Dance Company",
y = "Percentage of Change in Endowment Balance") +
theme(axis.text.x = element_blank()) +
geom_hline(yintercept = 100, linetype = "dotted", color = "maroon") +
scale_colour_manual(values = pal)
box_plot
#ggplotly(box_plot) %>%
# layout(showlegend = FALSE)
##Limited to 100 for visibility
box_plot_lim <- ggplot(pct_change_ds_box, aes(x = organization_name, y = pct_change)) +
geom_boxplot(aes(color = organization_name), show.legend = FALSE) +
geom_point(size = 1, alpha = 0.5) +
theme_bw() +
labs(title = "Range of Endowment % Change (Max of 100) per Company",
x = "Dance Company",
y = "Percentage of Change in Endowment Balance") +
theme(axis.text.x = element_blank()) +
scale_y_continuous(breaks = scales::breaks_pretty(n = 20),
limit = c(-100,100)) +
scale_colour_manual(values = pal)
box_plot_lim
#ggplotly(box_plot_lim)  %>%
#layout(showlegend = FALSE)
## Ranges of different percent change
# reorder(organization_name, pull(summarize(spend_down, sd = sd(group_by(spend_down, pct_change)))), na.rm = TRUE)
# Reordering by standard deviation of pct_spend down
pct_change_inv_box <- pct_change_inv_ds %>%
group_by(organization_name) %>%
filter(pct_change != Inf) %>%
summarize(sd = sd(pct_change, na.rm = TRUE)) %>%
right_join(pct_change_ds, by = "organization_name") %>%
select(organization_name, EIN, pct_change, sd) %>%
mutate(organization_name = reorder(organization_name, -sd, na.rm = TRUE))
## Unlimited
box_plot_inv <- ggplot(pct_change_inv_box, aes(x = organization_name, y = pct_change)) +
geom_boxplot(aes(color = organization_name), show.legend = FALSE) +
geom_point(size = 1, alpha = 0.5) +
theme_bw() +
labs(title = "Range of Endowment Percent Change per Company",
x = "Dance Company",
y = "Percentage of Change in Endowment Balance") +
theme(axis.text.x = element_blank()) +
geom_hline(yintercept = 100, linetype = "dotted", color = "maroon") +
scale_colour_manual(values = pal)
box_plot_inv
#ggplotly(box_plot_inv) %>%
#layout(showlegend = FALSE)
##Limited to 100 for visibility
box_plot_inv_lim <- ggplot(pct_change_inv_box, aes(x = organization_name, y = pct_change)) +
geom_boxplot(aes(color = organization_name), show.legend = FALSE) +
geom_point(size = 1, alpha = 0.5) +
theme_bw() +
labs(title = "Range of Endowment % Change (Max of 100) per Company",
x = "Dance Company",
y = "Percentage of Change in Endowment Balance") +
theme(axis.text.x = element_blank()) +
scale_y_continuous(breaks = scales::breaks_pretty(n = 20),
limit = c(-100,100)) +
scale_colour_manual(values = pal)
#ggplotly(box_plot_inv_lim)  %>%
# layout(showlegend = FALSE)
## Retrieving median values
pct_change_med <- pct_change_ds %>%
group_by(fiscal_year) %>%
summarize(median = median(pct_change, na.rm = TRUE)) %>%
mutate(organization_name = "Median",
fiscal_year_dt = paste(fiscal_year, "-01-01", sep = ""))
pct_change_med$fiscal_year_dt = as.Date(pct_change_med$fiscal_year_dt, format = "%Y-%m-%d")
## Spend Down over Time
pct_change_plot <- pct_change_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(alpha = 0.5, show.legend =FALSE) +
theme_bw() +
scale_colour_manual(values = pal) +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20)) +
geom_hline(yintercept = 100, linetype = "dotted", color = "gray") +
geom_point(data = pct_change_med, aes(x = fiscal_year, y = median), color = "black", size = 1)
pct_change_plot
#ggplotly(pct_change_plot)
##Plot with Y scale between -100 and 100
limited_scale <- pct_change_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(show.legend = FALSE, alpha = 0.5) +
theme_bw() +
scale_colour_manual(values = pal) +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance (max 100)",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20),
limits = c(-100, 100))  +
geom_point(data = pct_change_med, aes(x = fiscal_year, y = median), color = "black", size = 1)
limited_scale
#ggplotly(limited_scale)
## Retrieving median values
pct_change_inv_med <- pct_change_inv_ds %>%
group_by(fiscal_year) %>%
summarize(median = median(pct_change, na.rm = TRUE)) %>%
mutate(organization_name = "Median")
## Spend Down over Time
pct_change_inv_plot <- pct_change_inv_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(alpha = 0.5, show.legend = FALSE) +
scale_colour_manual(values = pal) +
theme_bw() +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20)) +
geom_hline(yintercept = 100, linetype = "dotted", color = "gray")  +
geom_point(data = pct_change_inv_med, aes(x = fiscal_year, y = median), color = "black", size = 1)
pct_change_inv_plot
#ggplotly(pct_change_inv_plot)
##Plot with Y scale between -100 and 100
limited_scale_inv <- pct_change_inv_ds %>%
filter(pct_change != Inf) %>%
ggplot(aes(x = fiscal_year, y = pct_change,
group = organization_name, color = organization_name)) +
geom_line(show.legend = FALSE, alpha = 0.5) +
scale_colour_manual(values = pal) +
theme_bw() +
labs(y = "Percent Change",
x = "Fiscal Year",
title = "Percentage of Change in Endowment Balance (max 100)",
subtitle = "By Fiscal Year") +
theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
axis.title = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
axis.text.x = element_text(size = 10, angle = 25),
strip.text = element_text(face="bold",size = 5),
legend.key.size = unit(1, 'mm'),
legend.text = element_text(size=7)) +
scale_y_continuous(labels = scales::comma_format(),
breaks = scales::pretty_breaks(n = 20),
limits = c(-100, 100))  +
geom_point(data = pct_change_inv_med, aes(x = fiscal_year, y = median), color = "black", size = 0.5)
limited_scale_inv
#ggplotly(limited_scale_inv)
## Adding end date
source(here("GET_VARS.R"))
##Specifically reading in Tax Period End Date
files <- dir( here("ballet_990_released_20230208"),
full.names = TRUE)
taxperiod_data <- map_df(files, ~
get_df(variables =  c("//Return//ReturnHeader//TaxPeriodEndDt"),
filename = .x
))
taxperiod_data$fiscal_year = as.numeric(as.character(taxperiod_data$fiscal_year))
pct_change_ds <- pct_change_ds %>%
left_join(taxperiod_data, by = c("EIN", "fiscal_year"))
View(taxperiod_data)
